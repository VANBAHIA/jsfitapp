<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Meus Treinos</title>
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Meus Treinos">
    <meta name="theme-color" content="#2563eb">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMyNTYzZWIiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtNi4zIDIwLjMgMi4zLTIuM2E0IDQgMCAwIDEgNS42NiAwIDQgNCAwIDAgMCA1LjY2IDBsMi4zIDIuMyIvPgo8cGF0aCBkPSJNNiAzaDEyYTMgMyAwIDAgMSAzIDN2NmEzIDMgMCAwIDEtMyAzSDZhMyAzIDAgMCAxLTMtM1Y2YTMgMyAwIDAgMSAzLTN6Ii8+Cjwvc3ZnPgo8L3N2Zz4K">
    <link rel="stylesheet" type="text/css" href="css/stylealuno.css">
    <style>
       
    </style>

</head>
<body>
    <div id="app" class="app">
        <div class="connection-status" id="connectionStatus"></div>
        
        <!-- Home View -->
        <div id="homeView" class="view">
            <div class="header">
                <div class="header-content">
                    <h1 class="title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m6.3 20.3 2.3-2.3a4 4 0 0 1 5.66 0 4 4 0 0 0 5.66 0l2.3 2.3"/>
                            <path d="M6 3h12a3 3 0 0 1 3 3v6a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3z"/>
                        </svg>
                        Meus Treinos
                    </h1>
                </div>
            </div>
            <div class="content" id="homeContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Plan View -->
        <div id="planView" class="view hidden">
            <div class="header">
                <div class="header-content">
                    <button class="back-btn show" onclick="showHome()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m15 18-6-6 6-6"/>
                        </svg>
                    </button>
                    <div>
                        <h1 class="title" id="planTitle">Plano</h1>
                        <p class="subtitle" id="planSubtitle">Per√≠odo</p>
                    </div>
                </div>
            </div>
            <div class="content" id="planContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Workout View -->
        <div id="workoutView" class="view hidden">
            <div class="header">
                <div class="header-content">
                    <button class="back-btn show" onclick="showPlan()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m15 18-6-6 6-6"/>
                        </svg>
                    </button>
                    <div>
                        <h1 class="title" id="workoutTitle">Treino</h1>
                        <p class="subtitle" id="workoutSubtitle">Exerc√≠cios</p>
                    </div>
                </div>
            </div>
            <div class="content" id="workoutContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal">
            <h3 class="modal-title">Confirmar Exclus√£o</h3>
            <p class="modal-message" id="confirmationMessage">
                Tem certeza de que deseja excluir este plano? Esta a√ß√£o n√£o pode ser desfeita.
            </p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideConfirmation()">Cancelar</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let workoutPlans = [];
        let currentPlan = null;
        let currentWorkout = null;
        let activeWorkoutSessions = {};
        let editingWeight = {};
        let serverConnection = {
            isOnline: false,
            lastCheck: null,
            retryCount: 0
        };
        
        // Configura√ß√£o da API - ALTERE A URL PARA O SEU SERVIDOR
        const API_CONFIG = {
            baseUrl: 'https://jsfitapp.netlify.app/api', // Usar o mesmo dom√≠nio
            timeout: 5000,
            retries: 3,
            endpoints: {
                getWorkout: '/workouts',
                health: '/health'
            }
        };

        // API de Comunica√ß√£o com Servidor
        class WorkoutServerAPI {
            static async checkServerHealth() {
                try {
                    updateConnectionStatus('loading');
                    const response = await this.makeRequest(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.health}`);
                    serverConnection.isOnline = response.ok;
                    serverConnection.lastCheck = new Date();
                    updateConnectionStatus(serverConnection.isOnline ? 'online' : 'offline');
                    return serverConnection.isOnline;
                } catch (error) {
                    console.error('Erro ao verificar servidor:', error);
                    serverConnection.isOnline = false;
                    updateConnectionStatus('offline');
                    return false;
                }
            }

            static async getWorkoutById(shareId) {
                try {
                    if (!serverConnection.isOnline) {
                        throw new Error('Servidor offline');
                    }

                    const response = await this.makeRequest(
                        `${API_CONFIG.baseUrl}${API_CONFIG.endpoints.getWorkout}/${shareId}`,
                        {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Plano n√£o encontrado no servidor');
                        } else if (response.status === 500) {
                            throw new Error('Erro interno do servidor');
                        } else {
                            throw new Error(`Erro do servidor: ${response.status}`);
                        }
                    }

                    const data = await response.json();
                    return {
                        success: true,
                        data: data,
                        source: 'server'
                    };

                } catch (error) {
                    console.error('Erro ao buscar do servidor:', error);
                    // Fallback para armazenamento local
                    return await this.getFromLocalFallback(shareId);
                }
            }

            static async getFromLocalFallback(shareId) {
                try {
                    const sharedPlans = getSharedPlans();
                    const localData = sharedPlans[shareId.toUpperCase()];
                    
                    if (localData) {
                        console.log(`[FALLBACK] Plano ${shareId} encontrado localmente`);
                        return {
                            success: true,
                            data: localData,
                            source: 'local'
                        };
                    } else {
                        throw new Error('Plano n√£o encontrado nem no servidor nem localmente');
                    }
                } catch (error) {
                    console.error('Erro no fallback local:', error);
                    throw error;
                }
            }

            static async makeRequest(url, options = {}) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Timeout na conex√£o com servidor');
                    }
                    throw error;
                }
            }
        }

        // Status de conex√£o
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionStatus');
            indicator.className = `connection-status ${status}`;
            
            switch(status) {
                case 'online':
                    indicator.title = 'Conectado ao servidor';
                    break;
                case 'offline':
                    indicator.title = 'Servidor offline - usando cache local';
                    break;
                case 'loading':
                    indicator.title = 'Verificando conex√£o...';
                    break;
            }
        }

        // Sistema de Importa√ß√£o por ID - Melhorado
        function getSharedPlans() {
            try {
                const stored = localStorage.getItem('sharedWorkoutPlans');
                return stored ? JSON.parse(stored) : {};
            } catch (error) {
                console.error('Erro ao carregar planos compartilhados:', error);
                return {};
            }
        }
        
        async function importPlanById(shareId) {
            try {
                // Verificar se j√° foi importado
                const existingPlan = workoutPlans.find(p => p.originalShareId === shareId.toUpperCase());
                if (existingPlan) {
                    throw new Error('Este plano j√° foi importado');
                }

                // Tentar buscar do servidor primeiro
                const serverResult = await WorkoutServerAPI.getWorkoutById(shareId);
                
                let planData;
                let source = serverResult.source;

                if (serverResult.success) {
                    planData = serverResult.data;
                    
                    // Se veio do servidor, salvar localmente como cache
                    if (source === 'server') {
                        const sharedPlans = getSharedPlans();
                        sharedPlans[shareId.toUpperCase()] = planData;
                        localStorage.setItem('sharedWorkoutPlans', JSON.stringify(sharedPlans));
                        console.log('Plano salvo no cache local');
                    }
                } else {
                    throw new Error('Falha ao buscar plano');
                }

                // Processar dados do plano
                const importedPlan = {
                    ...planData.plan,
                    id: Date.now() + Math.random(),
                    originalShareId: shareId.toUpperCase(),
                    importedAt: new Date().toISOString(),
                    importedFrom: source,
                    execucoesPlanCompleto: 0,
                    treinos: planData.plan.treinos.map(treino => ({
                        ...treino,
                        concluido: false,
                        execucoes: 0,
                        exercicios: treino.exercicios.map(ex => ({
                            ...ex,
                            concluido: false,
                            currentCarga: ex.carga // Armazenar carga edit√°vel
                        }))
                    }))
                };

                return {
                    plan: importedPlan,
                    source: source
                };

            } catch (error) {
                console.error('Erro ao importar plano:', error);
                throw error;
            }
        }
        
        // Example data
        const exampleData = {
            "planos": [
                {
                    "id": 2,
                    "nome": "Adapta√ß√£o Iniciante - Full Body (2 meses)",
                    "dias": 3,
                    "dataInicio": "2025-08-06",
                    "dataFim": "2025-10-06",
                    "perfil": {
                        "idade": "18-50 anos",
                        "altura": "Vari√°vel",
                        "peso": "Vari√°vel",
                        "porte": "Iniciante",
                        "objetivo": "Adapta√ß√£o anat√¥mica e aprendizado de movimentos"
                    },
                    "treinos": [
                        {
                            "id": "FULL1",
                            "nome": "Full Body A - Adapta√ß√£o",
                            "foco": "Corpo inteiro - Movimentos b√°sicos",
                            "exercicios": [
                                {
                                    "id": 1,
                                    "nome": "Aquecimento - Esteira",
                                    "descricao": "Caminhada leve para aquecimento geral",
                                    "series": 1,
                                    "repeticoes": "8 min",
                                    "carga": "Velocidade 5-6 km/h",
                                    "currentCarga": "Velocidade 5-6 km/h",
                                    "concluido": false
                                },
                                {
                                    "id": 2,
                                    "nome": "Agachamento Corporal",
                                    "descricao": "Movimento b√°sico para aprender padr√£o de agachamento",
                                    "series": 2,
                                    "repeticoes": 15,
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                },
                                {
                                    "id": 3,
                                    "nome": "Flex√£o no Joelho",
                                    "descricao": "Flex√£o adaptada para iniciantes",
                                    "series": 2,
                                    "repeticoes": 10,
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                },
                                {
                                    "id": 4,
                                    "nome": "Remada com El√°stico",
                                    "descricao": "Movimento de puxada para costas",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "El√°stico leve",
                                    "currentCarga": "El√°stico leve",
                                    "concluido": false
                                },
                                {
                                    "id": 5,
                                    "nome": "Desenvolvimento com Bast√£o",
                                    "descricao": "Aprendizado do movimento de ombros",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "Bast√£o (2kg)",
                                    "currentCarga": "Bast√£o (2kg)",
                                    "concluido": false
                                },
                                {
                                    "id": 6,
                                    "nome": "Prancha Adaptada",
                                    "descricao": "Prancha com joelhos apoiados",
                                    "series": 2,
                                    "repeticoes": "20 seg",
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                },
                                {
                                    "id": 7,
                                    "nome": "Afundo Est√°tico",
                                    "descricao": "Afundo sem deslocamento",
                                    "series": 2,
                                    "repeticoes": 8,
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                },
                                {
                                    "id": 8,
                                    "nome": "Eleva√ß√£o de Bra√ßos",
                                    "descricao": "Movimento b√°sico para ombros",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "1kg cada",
                                    "currentCarga": "1kg cada",
                                    "concluido": false
                                },
                                {
                                    "id": 9,
                                    "nome": "Alongamento Geral",
                                    "descricao": "Alongamento de todos os grupos musculares",
                                    "series": 1,
                                    "repeticoes": "10 min",
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                }
                            ],
                            "concluido": false,
                            "execucoes": 0
                        },
                        {
                            "id": "FULL2",
                            "nome": "Full Body B - Progress√£o",
                            "foco": "Corpo inteiro - Introdu√ß√£o aos pesos",
                            "exercicios": [
                                {
                                    "id": 10,
                                    "nome": "Aquecimento - Bicicleta",
                                    "descricao": "Aquecimento cardiovascular suave",
                                    "series": 1,
                                    "repeticoes": "8 min",
                                    "carga": "Resist√™ncia m√≠nima",
                                    "currentCarga": "Resist√™ncia m√≠nima",
                                    "concluido": false
                                },
                                {
                                    "id": 11,
                                    "nome": "Leg Press Adaptado",
                                    "descricao": "Primeira experi√™ncia com m√°quina",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "20kg",
                                    "currentCarga": "20kg",
                                    "concluido": false
                                },
                                {
                                    "id": 12,
                                    "nome": "Supino com Halteres Leves",
                                    "descricao": "Introdu√ß√£o ao supino",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "5kg cada",
                                    "currentCarga": "5kg cada",
                                    "concluido": false
                                },
                                {
                                    "id": 13,
                                    "nome": "Puxada Alta Assistida",
                                    "descricao": "Puxada com contrapeso",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "15kg",
                                    "currentCarga": "15kg",
                                    "concluido": false
                                },
                                {
                                    "id": 14,
                                    "nome": "Desenvolvimento Sentado",
                                    "descricao": "Ombros com apoio nas costas",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "6kg cada",
                                    "currentCarga": "6kg cada",
                                    "concluido": false
                                },
                                {
                                    "id": 15,
                                    "nome": "Rosca B√≠ceps Simples",
                                    "descricao": "Movimento b√°sico para b√≠ceps",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "4kg cada",
                                    "currentCarga": "4kg cada",
                                    "concluido": false
                                },
                                {
                                    "id": 16,
                                    "nome": "Extens√£o de Tr√≠ceps",
                                    "descricao": "Movimento simples para tr√≠ceps",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "6kg",
                                    "currentCarga": "6kg",
                                    "concluido": false
                                },
                                {
                                    "id": 17,
                                    "nome": "Abdominal B√°sico",
                                    "descricao": "Abdominal tradicional",
                                    "series": 2,
                                    "repeticoes": 12,
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                },
                                {
                                    "id": 18,
                                    "nome": "Panturrilha Simples",
                                    "descricao": "Eleva√ß√£o de panturrilha em p√©",
                                    "series": 2,
                                    "repeticoes": 15,
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                },
                                {
                                    "id": 19,
                                    "nome": "Alongamento Dirigido",
                                    "descricao": "Alongamento focado nos m√∫sculos trabalhados",
                                    "series": 1,
                                    "repeticoes": "12 min",
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                }
                            ],
                            "concluido": false,
                            "execucoes": 0
                        },
                        {
                            "id": "FULL3",
                            "nome": "Full Body C - Consolida√ß√£o",
                            "foco": "Corpo inteiro - Prepara√ß√£o para divis√£o",
                            "exercicios": [
                                {
                                    "id": 20,
                                    "nome": "Aquecimento - El√≠ptico",
                                    "descricao": "Aquecimento completo de baixo impacto",
                                    "series": 1,
                                    "repeticoes": "10 min",
                                    "carga": "Resist√™ncia baixa",
                                    "currentCarga": "Resist√™ncia baixa",
                                    "concluido": false
                                },
                                {
                                    "id": 21,
                                    "nome": "Agachamento com Halteres",
                                    "descricao": "Agachamento com resist√™ncia externa",
                                    "series": 3,
                                    "repeticoes": 12,
                                    "carga": "8kg cada",
                                    "currentCarga": "8kg cada",
                                    "concluido": false
                                },
                                {
                                    "id": 22,
                                    "nome": "Supino Inclinado Leve",
                                    "descricao": "Varia√ß√£o do supino para peito superior",
                                    "series": 3,
                                    "repeticoes": 12,
                                    "carga": "8kg cada",
                                    "currentCarga": "8kg cada",
                                    "concluido": false
                                },
                                {
                                    "id": 23,
                                    "nome": "Remada Sentada",
                                    "descricao": "Exerc√≠cio para costas em m√°quina",
                                    "series": 3,
                                    "repeticoes": 12,
                                    "carga": "25kg",
                                    "currentCarga": "25kg",
                                    "concluido": false
                                },
                                {
                                    "id": 24,
                                    "nome": "Leg Press Progressivo",
                                    "descricao": "Leg press com mais carga",
                                    "series": 3,
                                    "repeticoes": 15,
                                    "carga": "40kg",
                                    "currentCarga": "40kg",
                                    "concluido": false
                                },
                                {
                                    "id": 25,
                                    "nome": "Desenvolvimento Militar",
                                    "descricao": "Ombros com barra ou halteres",
                                    "series": 3,
                                    "repeticoes": 10,
                                    "carga": "15kg (barra)",
                                    "currentCarga": "15kg (barra)",
                                    "concluido": false
                                },
                                {
                                    "id": 26,
                                    "nome": "Rosca Direta Inicial",
                                    "descricao": "B√≠ceps com barra leve",
                                    "series": 3,
                                    "repeticoes": 12,
                                    "carga": "12kg",
                                    "currentCarga": "12kg",
                                    "concluido": false
                                },
                                {
                                    "id": 27,
                                    "nome": "Tr√≠ceps Pulley",
                                    "descricao": "Tr√≠ceps na polia com carga leve",
                                    "series": 3,
                                    "repeticoes": 12,
                                    "carga": "15kg",
                                    "currentCarga": "15kg",
                                    "concluido": false
                                },
                                {
                                    "id": 28,
                                    "nome": "Prancha Completa",
                                    "descricao": "Prancha tradicional",
                                    "series": 3,
                                    "repeticoes": "30 seg",
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                },
                                {
                                    "id": 29,
                                    "nome": "Panturrilha com Peso",
                                    "descricao": "Panturrilha com halteres",
                                    "series": 3,
                                    "repeticoes": 15,
                                    "carga": "10kg cada",
                                    "currentCarga": "10kg cada",
                                    "concluido": false
                                },
                                {
                                    "id": 30,
                                    "nome": "Alongamento Final",
                                    "descricao": "Relaxamento e recupera√ß√£o",
                                    "series": 1,
                                    "repeticoes": "15 min",
                                    "carga": "Corpo",
                                    "currentCarga": "Corpo",
                                    "concluido": false
                                }
                            ],
                            "concluido": false,
                            "execucoes": 0
                        }
                    ],
                    "observacoes": {
                        "frequencia": "3x por semana (segunda, quarta, sexta) com 1 dia de descanso entre sess√µes",
                        "progressao": "Semanas 1-2: Full Body A | Semanas 3-5: Full Body B | Semanas 6-8: Full Body C",
                        "descanso": "45-60 segundos entre s√©ries, foco na recupera√ß√£o completa",
                        "hidratacao": "Beber √°gua antes, durante e ap√≥s o treino",
                        "adaptacao": "Per√≠odo crucial para aprender movimentos e criar base muscular",
                        "supervisionamento": "OBRIGAT√ìRIO acompanhamento profissional nas primeiras semanas",
                        "sinais_alerta": "Pare imediatamente se sentir dor aguda, tontura ou desconforto anormal",
                        "evolucao": "Ap√≥s 8 semanas, avaliar progress√£o para treino ABC ou ABCD",
                        "tecnica": "Prioridade ABSOLUTA na execu√ß√£o correta dos movimentos",
                        "consulta": "Avalia√ß√£o m√©dica obrigat√≥ria antes do in√≠cio do programa"
                    }
                }
            ]
        };
        
        // Utility functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }
        
        function isWorkoutActive(planId, workoutId) {
            const sessionKey = `${planId}-${workoutId}`;
            return activeWorkoutSessions[sessionKey] !== undefined;
        }
        
        function saveToLocalStorage() {
            try {
                localStorage.setItem('studentWorkoutPlans', JSON.stringify(workoutPlans));
            } catch (error) {
                console.error('Erro ao salvar:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('studentWorkoutPlans');
                if (stored) {
                    workoutPlans = JSON.parse(stored);
                    // Migrar dados antigos que n√£o possuem currentCarga
                    workoutPlans.forEach(plan => {
                        plan.treinos.forEach(treino => {
                            treino.exercicios.forEach(ex => {
                                if (!ex.currentCarga) {
                                    ex.currentCarga = ex.carga;
                                }
                            });
                        });
                    });
                    saveToLocalStorage();
                }
            } catch (error) {
                console.error('Erro ao carregar:', error);
                workoutPlans = [];
            }
        }
        
        // Weight editing functions
        function startEditingWeight(exerciseId) {
            editingWeight[exerciseId] = true;
            renderWorkout();
        }
        
        function cancelEditingWeight(exerciseId) {
            delete editingWeight[exerciseId];
            renderWorkout();
        }
        
        function saveWeight(planId, workoutId, exerciseId) {
            const inputId = `weight-input-${exerciseId}`;
            const newWeight = document.getElementById(inputId).value.trim();
            
            if (!newWeight) {
                alert('Por favor, insira uma carga v√°lida');
                return;
            }
            
            const plan = workoutPlans.find(p => p.id === planId);
            const workout = plan.treinos.find(t => t.id === workoutId);
            const exercise = workout.exercicios.find(e => e.id === exerciseId);
            
            exercise.currentCarga = newWeight;
            delete editingWeight[exerciseId];
            
            saveToLocalStorage();
            renderWorkout();
        }
        
        // Confirmation Modal functions
        function showConfirmation(title, message, onConfirm) {
            document.getElementById('confirmationMessage').textContent = message;
            document.querySelector('.modal-title').textContent = title;
            document.getElementById('confirmDeleteBtn').onclick = onConfirm;
            document.getElementById('confirmationModal').classList.remove('hidden');
        }
        
        function hideConfirmation() {
            document.getElementById('confirmationModal').classList.add('hidden');
        }
        
        // Delete plan function
        function deletePlan(planId) {
            const plan = workoutPlans.find(p => p.id === planId);
            if (!plan) return;
            
            // Check if there are active workouts for this plan
            const hasActiveWorkouts = Object.keys(activeWorkoutSessions).some(key => 
                key.startsWith(`${planId}-`)
            );
            
            if (hasActiveWorkouts) {
                showConfirmation(
                    'Plano em Uso',
                    `O plano "${plan.nome}" possui treinos em andamento. Deseja mesmo exclu√≠-lo? Os treinos ativos ser√£o perdidos.`,
                    () => confirmDeletePlan(planId)
                );
            } else {
                showConfirmation(
                    'Confirmar Exclus√£o',
                    `Tem certeza de que deseja excluir o plano "${plan.nome}"? Esta a√ß√£o n√£o pode ser desfeita.`,
                    () => confirmDeletePlan(planId)
                );
            }
        }
        
        function confirmDeletePlan(planId) {
            // Remove active workout sessions for this plan
            Object.keys(activeWorkoutSessions).forEach(key => {
                if (key.startsWith(`${planId}-`)) {
                    delete activeWorkoutSessions[key];
                }
            });
            
            // Remove plan from array
            workoutPlans = workoutPlans.filter(p => p.id !== planId);
            
            // Save changes
            saveToLocalStorage();
            
            // Hide confirmation modal
            hideConfirmation();
            
            // If we're currently viewing the deleted plan, go back to home
            if (currentPlan && currentPlan.id === planId) {
                currentPlan = null;
                showHome();
            } else {
                // Just refresh the current view
                renderHome();
            }
            
            // Show success message
            setTimeout(() => {
                alert('Plano exclu√≠do com sucesso!');
            }, 100);
        }
        
        // Navigation functions
        function showView(viewId) {
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        function showHome() {
            showView('homeView');
            renderHome();
        }
        
        function showPlan(planId = null) {
            if (planId) {
                currentPlan = workoutPlans.find(p => p.id === planId);
            }
            showView('planView');
            renderPlan();
        }
        
        function showWorkout(workoutId) {
            currentWorkout = currentPlan.treinos.find(t => t.id === workoutId);
            showView('workoutView');
            renderWorkout();
        }
        
        // Data functions
        function loadExampleData() {
            workoutPlans = JSON.parse(JSON.stringify(exampleData.planos));
            saveToLocalStorage();
            renderHome();
        }
        
        function importJSON(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.planos && Array.isArray(data.planos)) {
                            const processedPlans = data.planos.map(plan => ({
                                ...plan,
                                id: Date.now() + Math.random(),
                                execucoesPlanCompleto: plan.execucoesPlanCompleto || 0,
                                treinos: plan.treinos.map(treino => ({
                                    ...treino,
                                    exercicios: treino.exercicios.map(ex => ({
                                        ...ex,
                                        currentCarga: ex.currentCarga || ex.carga
                                    }))
                                }))
                            }));
                            workoutPlans.push(...processedPlans);
                            saveToLocalStorage();
                            renderHome();
                            alert(`${processedPlans.length} plano(s) importado(s) com sucesso!`);
                        } else {
                            alert('Formato JSON inv√°lido. Verifique a estrutura do arquivo.');
                        }
                    } catch (error) {
                        alert('Erro ao ler arquivo JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }
        
        // Fun√ß√£o melhorada de importa√ß√£o por ID
        async function handleImportById() {
            const input = document.getElementById('importIdInput');
            const button = document.getElementById('importIdButton');
            const status = document.getElementById('importStatus');
            
            const shareId = input.value.trim().toUpperCase();
            
            // Valida√ß√µes
            if (!shareId) {
                updateImportStatus('Digite um ID v√°lido', 'error');
                return;
            }
            
            if (shareId.length !== 6) {
                updateImportStatus('ID deve ter 6 caracteres', 'error');
                return;
            }
            
            // Mostrar loading
            button.innerHTML = '<span class="loading-spinner"></span> Buscando...';
            button.classList.add('btn-loading');
            updateImportStatus('Conectando com servidor...', 'loading');
            
            try {
                // Tentar importar do servidor
                const result = await importPlanById(shareId);
                
                // Adicionar √† lista
                workoutPlans.push(result.plan);
                saveToLocalStorage();
                
                // Feedback de sucesso
                const sourceText = result.source === 'server' ? 'servidor' : 'cache local';
                updateImportStatus(`‚úÖ Plano "${result.plan.nome}" importado do ${sourceText}!`, 'success');
                input.value = '';
                
                setTimeout(() => {
                    renderHome();
                }, 1500);
                
            } catch (error) {
                console.error('Erro na importa√ß√£o:', error);
                updateImportStatus(`‚ùå ${error.message}`, 'error');
            } finally {
                // Restaurar bot√£o
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" x2="12" y1="15" y2="3"/>
                    </svg>
                    Importar por ID
                `;
                button.classList.remove('btn-loading');
            }
        }
        
        function updateImportStatus(message, type) {
            const status = document.getElementById('importStatus');
            status.textContent = message;
            status.className = `import-status ${type}`;
        }
        
        function startWorkout(planId, workoutId) {
            const sessionKey = `${planId}-${workoutId}`;
            activeWorkoutSessions[sessionKey] = {
                startTime: new Date(),
                planId,
                workoutId
            };
            
            // Reset exercises
            const plan = workoutPlans.find(p => p.id === planId);
            const workout = plan.treinos.find(t => t.id === workoutId);
            workout.exercicios.forEach(ex => ex.concluido = false);
            workout.concluido = false;
            
            if (currentPlan && currentPlan.id === planId) {
                renderPlan();
            }
        }
        
        function completeExercise(planId, workoutId, exerciseId) {
            // Verificar se o treino est√° ativo
            const sessionKey = `${planId}-${workoutId}`;
            if (!activeWorkoutSessions[sessionKey]) {
                alert('O treino n√£o est√° ativo. Inicie o treino na tela anterior primeiro.');
                return;
            }
            
            const plan = workoutPlans.find(p => p.id === planId);
            const workout = plan.treinos.find(t => t.id === workoutId);
            const exercise = workout.exercicios.find(e => e.id === exerciseId);
            exercise.concluido = true;
            
            saveToLocalStorage();
            renderWorkout();
        }
        
        function completeWorkout(planId, workoutId) {
            const sessionKey = `${planId}-${workoutId}`;
            const plan = workoutPlans.find(p => p.id === planId);
            const workout = plan.treinos.find(t => t.id === workoutId);
            
            // Mark workout as completed and increment executions
            workout.concluido = true;
            workout.execucoes += 1;
            
            // Remove active session
            delete activeWorkoutSessions[sessionKey];
            
            // Check if all workouts in the plan are completed
            const allWorkoutsCompleted = plan.treinos.every(t => t.concluido);
            
            if (allWorkoutsCompleted) {
                // Increment plan completion counter
                plan.execucoesPlanCompleto = (plan.execucoesPlanCompleto || 0) + 1;
                
                // Reset all workouts for next cycle
                plan.treinos.forEach(t => {
                    t.concluido = false;
                    t.exercicios.forEach(e => e.concluido = false);
                });
                
                setTimeout(() => {
                    alert(`üéä Parab√©ns! Voc√™ completou o ciclo ${plan.execucoesPlanCompleto} do plano "${plan.nome}"!\n\nTodos os treinos foram resetados para o pr√≥ximo ciclo.`);
                }, 500);
            }
            
            saveToLocalStorage();
            
            setTimeout(() => {
                alert('üéâ Treino conclu√≠do com sucesso!');
                showPlan();
            }, 100);
        }
        
        // Render functions
        function renderHome() {
            const content = document.getElementById('homeContent');
            
            let html = `
                <!-- Import by ID Card - Enhanced -->
                <div class="card import-by-id-card">
                    <div class="card-content">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; text-align: center;">
                            üîó Importar Treino por ID
                        </h3>
                        <div class="server-status ${serverConnection.isOnline ? 'online' : 'offline'}">
                            ${serverConnection.isOnline ? 
                                'üü¢ Servidor online - Buscar√° do servidor' : 
                                'üü° Servidor offline - Usando cache local'
                            }
                        </div>
                        <div class="import-form">
                            <input type="text" id="importIdInput" class="import-input" 
                                   placeholder="Digite o ID (6 caracteres)" 
                                   maxlength="6" 
                                   onkeyup="this.value = this.value.toUpperCase()"
                                   onkeypress="if(event.key==='Enter') handleImportById()">
                            <button id="importIdButton" class="btn import-btn" onclick="handleImportById()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7,10 12,15 17,10"/>
                                    <line x1="12" x2="12" y1="15" y2="3"/>
                                </svg>
                                Importar por ID
                            </button>
                        </div>
                        <div id="importStatus" class="import-status">
                            Pe√ßa o ID do seu personal trainer
                        </div>
                    </div>
                </div>
            `;
            
            if (workoutPlans.length === 0) {
                html += `
                    <div class="card">
                        <div class="card-content empty-state">
                            <svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #d1d5db; margin: 0 auto 16px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" x2="12" y1="15" y2="3"/>
                            </svg>
                            <h3 class="empty-title">Nenhum plano importado</h3>
                            <p class="empty-description">Use o ID fornecido pelo seu personal trainer para importar seu plano de treino, ou carregue dados de exemplo</p>
                            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
                                <label class="btn btn-primary">
                                    Importar Arquivo JSON
                                    <input type="file" accept=".json" onchange="importJSON(event)" class="file-input">
                                </label>
                                <button onclick="loadExampleData()" class="btn btn-secondary">
                                    Carregar Treino de Adapta√ß√£o
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                workoutPlans.forEach(plan => {
                    const completedWorkouts = plan.treinos.filter(t => t.concluido).length;
                    const totalWorkouts = plan.treinos.length;
                    const totalExecutions = plan.treinos.reduce((sum, t) => sum + t.execucoes, 0);
                    
                    html += `
                        <div class="card">
                            <div class="card-content">
                                <div class="plan-header">
                                    <div>
                                        <h3 class="plan-title">${plan.nome}</h3>
                                        <p class="plan-subtitle">${plan.dias} dias por semana</p>
                                        ${plan.originalShareId ? `
                                            <div style="margin-top: 4px;">
                                                <span style="background: #16a34a; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">
                                                    ID: ${plan.originalShareId}
                                                </span>
                                                ${plan.importedFrom ? `
                                                    <span style="background: #2563eb; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; margin-left: 4px;">
                                                        ${plan.importedFrom === 'server' ? 'üåê Servidor' : 'üíæ Cache'}
                                                    </span>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="date-info">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M8 2v4"/>
                                            <path d="M16 2v4"/>
                                            <rect width="18" height="18" x="3" y="4" rx="2"/>
                                            <path d="M3 10h18"/>
                                        </svg>
                                        <div>
                                            <div>${formatDate(plan.dataInicio)}</div>
                                            <div>${formatDate(plan.dataFim)}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="home-plan-stats">
                                    <div class="home-stat-item">
                                        <div class="home-stat-value">${plan.execucoesPlanCompleto || 0}</div>
                                        <div class="home-stat-label">Ciclos Completos</div>
                                    </div>
                                    <div class="home-stat-item">
                                        <div class="home-stat-value">${completedWorkouts}/${totalWorkouts}</div>
                                        <div class="home-stat-label">Treinos no Ciclo</div>
                                    </div>
                                    <div class="home-stat-item">
                                        <div class="home-stat-value">${totalExecutions}</div>
                                        <div class="home-stat-label">Total de Treinos</div>
                                    </div>
                                </div>
                                <div class="workout-grid">
                                    ${plan.treinos.map(treino => `
                                        <div class="workout-item" style="${treino.concluido ? 'background: #dcfce7; border-left: 3px solid #16a34a;' : ''}">
                                            <span class="workout-name" style="${treino.concluido ? 'color: #15803d;' : ''}">${treino.nome}</span>
                                            <span class="execution-count" style="${treino.concluido ? 'background: #16a34a; color: white;' : ''}">${treino.execucoes}x</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="plan-actions">
                                    <button onclick="showPlan(${plan.id})" class="btn btn-primary">
                                        Ver Plano
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m9 18 6-6-6-6"/>
                                        </svg>
                                    </button>
                                    <button onclick="deletePlan(${plan.id})" class="btn btn-danger delete-btn" title="Excluir Plano">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m3 6 18 0"/>
                                            <path d="m19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                            <path d="m8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div style="text-align: center; margin-top: 24px;">
                        <label class="btn btn-success">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14"/>
                                <path d="m12 5 0 14"/>
                            </svg>
                            Adicionar Novo Plano
                            <input type="file" accept=".json" onchange="importJSON(event)" class="file-input">
                        </label>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }
        
        function renderPlan() {
            if (!currentPlan) return;
            
            document.getElementById('planTitle').textContent = currentPlan.nome;
            document.getElementById('planSubtitle').textContent = `${formatDate(currentPlan.dataInicio)} - ${formatDate(currentPlan.dataFim)}`;
            
            const completedWorkouts = currentPlan.treinos.filter(t => t.concluido).length;
            const totalWorkouts = currentPlan.treinos.length;
            const cycleProgress = (completedWorkouts / totalWorkouts) * 100;
            const totalExecutions = currentPlan.treinos.reduce((sum, t) => sum + t.execucoes, 0);
            
            let html = `
                <div class="plan-cycle-info">
                    <div class="cycle-counter">${currentPlan.execucoesPlanCompleto || 0}</div>
                    <div class="cycle-label">Ciclos Completos do Plano</div>
                    <div class="cycle-progress">
                        <div class="cycle-progress-fill" style="width: ${cycleProgress}%;"></div>
                    </div>
                    <div class="cycle-status">
                        ${completedWorkouts === totalWorkouts 
                            ? 'üéâ Ciclo atual completo! Pr√≥ximo treino iniciar√° um novo ciclo.'
                            : `Progresso do ciclo atual: ${completedWorkouts}/${totalWorkouts} treinos (${Math.round(cycleProgress)}%)`
                        }
                    </div>
                    <div style="margin-top: 12px; font-size: 14px; opacity: 0.8;">
                        Total de treinos executados: ${totalExecutions}
                    </div>
                    ${currentPlan.originalShareId ? `
                        <div style="margin-top: 8px; font-size: 12px; opacity: 0.7;">
                            Plano importado via ID: ${currentPlan.originalShareId}
                            ${currentPlan.importedFrom ? ` (${currentPlan.importedFrom === 'server' ? 'Servidor' : 'Cache local'})` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
            
            currentPlan.treinos.forEach(treino => {
                const isActive = isWorkoutActive(currentPlan.id, treino.id);
                const completedExercises = treino.exercicios.filter(ex => ex.concluido).length;
                const totalExercises = treino.exercicios.length;
                const isCompleted = treino.concluido;
                
                html += `
                    <div class="card ${isCompleted ? 'completed' : ''}">
                        <div class="card-content">
                            <div class="plan-header">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <h3 class="plan-title">${treino.nome}</h3>
                                        ${isCompleted ? `
                                            <div class="check-icon" style="font-size: 12px; padding: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="m9 12 2 2 4-4"/>
                                                </svg>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <p class="plan-subtitle" style="${isCompleted ? 'color: #16a34a;' : ''}">
                                        ${isCompleted 
                                            ? `‚úÖ Treino conclu√≠do ‚Ä¢ ${totalExercises} exerc√≠cios ‚Ä¢ Executado ${treino.execucoes}x`
                                            : `${totalExercises} exerc√≠cios ‚Ä¢ Executado ${treino.execucoes}x`
                                        }
                                    </p>
                                    ${isActive ? '<div class="active-workout">Treino em andamento</div>' : ''}
                                </div>
                                <div style="text-align: right;">
                                    <div class="plan-subtitle" style="margin-bottom: 8px;">Progresso: ${completedExercises}/${totalExercises}</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${(completedExercises / totalExercises) * 100}%; background-color: ${isCompleted ? '#16a34a' : '#2563eb'};"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="workout-actions">
                                <button onclick="showWorkout('${treino.id}')" class="btn btn-primary btn-secondary">
                                    Ver Exerc√≠cios
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="m9 18 6-6-6-6"/>
                                    </svg>
                                </button>
                                ${!isActive ? `
                                    <button onclick="startWorkout(${currentPlan.id}, '${treino.id}')" class="btn ${isCompleted ? 'btn-warning' : 'btn-success'}" style="padding: 16px 24px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="6,3 20,12 6,21"/>
                                        </svg>
                                        ${isCompleted ? 'Repetir' : 'Iniciar'}
                                    </button>
                                ` : `
                                    <button onclick="completeWorkout(${currentPlan.id}, '${treino.id}')" 
                                            class="${completedExercises < totalExercises ? 'btn btn-disabled' : 'btn btn-warning'}" 
                                            ${completedExercises < totalExercises ? 'disabled' : ''} 
                                            style="padding: 16px 24px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m9 12 2 2 4-4"/>
                                        </svg>
                                        Concluir
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('planContent').innerHTML = html;
        }
        
        function renderWorkout() {
            if (!currentWorkout || !currentPlan) return;
            
            document.getElementById('workoutTitle').textContent = currentWorkout.nome;
            document.getElementById('workoutSubtitle').textContent = `${currentWorkout.exercicios.length} exerc√≠cios`;
            
            const isWorkoutActiveNow = isWorkoutActive(currentPlan.id, currentWorkout.id);
            
            let html = '';
            
            // Adicionar alerta se o treino n√£o estiver ativo
            if (!isWorkoutActiveNow) {
                html += `
                    <div class="alert">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        Para realizar os exerc√≠cios, voc√™ precisa iniciar o treino na tela anterior
                    </div>
                `;
            }
            
            currentWorkout.exercicios.forEach((exercicio, index) => {
                const isEditing = editingWeight[exercicio.id];
                const cardClass = isWorkoutActiveNow 
                    ? (exercicio.concluido ? 'completed' : 'pending')
                    : 'disabled';
                
                html += `
                    <div class="card exercise-card ${cardClass}">
                        <div class="card-content">
                            <div class="exercise-header">
                                <div style="flex: 1;">
                                    <h3 class="exercise-number">${index + 1}. ${exercicio.nome}</h3>
                                    <p class="exercise-description">${exercicio.descricao}</p>
                                </div>
                                ${exercicio.concluido && isWorkoutActiveNow ? `
                                    <div class="check-icon">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m9 12 2 2 4-4"/>
                                        </svg>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value">${exercicio.series}</div>
                                    <div class="stat-label">S√©ries</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${exercicio.repeticoes}</div>
                                    <div class="stat-label">Repeti√ß√µes</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${exercicio.currentCarga}</div>
                                    <div class="stat-label">Carga Atual</div>
                                </div>
                            </div>
                            
                            ${exercicio.currentCarga !== exercicio.carga ? `
                                <div class="current-weight">
                                    Carga original: ${exercicio.carga}
                                </div>
                            ` : ''}
                            
                            ${isEditing ? `
                                <div class="weight-edit">
                                    <input type="text" id="weight-input-${exercicio.id}" 
                                           class="weight-input" 
                                           value="${exercicio.currentCarga}" 
                                           placeholder="Digite a nova carga">
                                    <button onclick="saveWeight(${currentPlan.id}, '${currentWorkout.id}', ${exercicio.id})" 
                                            class="btn btn-success btn-weight">
                                        Salvar
                                    </button>
                                    <button onclick="cancelEditingWeight(${exercicio.id})" 
                                            class="btn btn-secondary btn-weight">
                                        Cancelar
                                    </button>
                                </div>
                            ` : `
                                <div style="display: flex; gap: 8px; margin-top: 12px;">
                                    <button onclick="startEditingWeight(${exercicio.id})" 
                                            class="btn btn-secondary" style="flex: 1;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                        Editar Carga
                                    </button>
                                    
                                    ${isWorkoutActiveNow ? `
                                        <button onclick="completeExercise(${currentPlan.id}, '${currentWorkout.id}', ${exercicio.id})" 
                                                ${exercicio.concluido ? 'disabled' : ''} 
                                                class="${exercicio.concluido ? 'btn btn-disabled' : 'btn btn-success'}" 
                                                style="flex: 1;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="m9 12 2 2 4-4"/>
                                            </svg>
                                            ${exercicio.concluido ? 'Conclu√≠do' : 'Concluir'}
                                        </button>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });
            
            // Add completion card if workout is active
            if (isWorkoutActiveNow) {
                const allCompleted = currentWorkout.exercicios.every(ex => ex.concluido);
                
                html += `
                    <div class="card">
                        <div class="card-content" style="text-align: center;">
                            <h3 class="plan-title" style="margin-bottom: 8px;">Treino em Andamento</h3>
                            <p class="plan-subtitle" style="margin-bottom: 16px;">Complete todos os exerc√≠cios para finalizar o treino</p>
                            <button onclick="completeWorkout(${currentPlan.id}, '${currentWorkout.id}')" 
                                    ${!allCompleted ? 'disabled' : ''} 
                                    class="${!allCompleted ? 'btn btn-disabled' : 'btn btn-warning'}" 
                                    style="max-width: 300px;">
                                Finalizar Treino
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('workoutContent').innerHTML = html;
        }
        
        // iOS compatibility functions
        function setupiOSCompatibility() {
            // Handle viewport height changes on iOS
            const setVH = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // iOS specific height fix
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    const app = document.querySelector('.app');
                    if (app) {
                        app.style.minHeight = window.innerHeight + 'px';
                    }
                }
            };
            
            setVH();
            
            // Debounced resize handler
            let resizeTimeout;
            const handleResize = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(setVH, 100);
            };
            
            window.addEventListener('resize', handleResize, { passive: true });
            window.addEventListener('orientationchange', () => {
                setTimeout(setVH, 500);
            }, { passive: true });
            
            // iOS Safari specific fixes
            window.addEventListener('load', () => {
                setVH();
                setTimeout(setVH, 0);
            });
            
            // Prevent iOS Safari bottom bar issues
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset === 0) {
                        setVH();
                    }
                }, { passive: true });
            }
            
            // iOS touch event handling
            let lastTouchEnd = 0;
            
            document.addEventListener('touchstart', (event) => {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchend', (event) => {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            document.addEventListener('gesturestart', (event) => {
                event.preventDefault();
            }, false);

            document.addEventListener('gesturechange', (event) => {
                event.preventDefault();
            }, false);

            document.addEventListener('gestureend', (event) => {
                event.preventDefault();
            }, false);

            // Prevent double-tap zoom
            let lastTouchStart = 0;
            document.addEventListener('touchstart', (event) => {
                const now = Date.now();
                if (now - lastTouchStart <= 500) {
                    event.preventDefault();
                }
                lastTouchStart = now;
            }, { passive: false });
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', (event) => {
            const modal = document.getElementById('confirmationModal');
            if (event.target === modal) {
                hideConfirmation();
            }
        });
        
        // Initialize app
        async function init() {
            setupiOSCompatibility();
            loadFromLocalStorage();
            
            // Verificar conex√£o com servidor
            await WorkoutServerAPI.checkServerHealth();
            
            // Verificar conex√£o periodicamente
            setInterval(async () => {
                await WorkoutServerAPI.checkServerHealth();
            }, 30000); // A cada 30 segundos
            
            renderHome();
        }
        
        // Start the app
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('load', init);
    </script>
</body>
</html>